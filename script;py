import yfinance as yf
import pandas as pd
import smtplib
import os
from email.message import EmailMessage

def enviar_relatorio():
    # Pega a senha do cofre do GitHub
    SUA_SENHA_APP = os.environ.get("EMAIL_PASSWORD")
    EMAIL_USER = "rohsmarcos1003166@gmail.com"
    
    # A√ß√µes que o rob√¥ vai vigiar
    tickers = ['PETR4.SA', 'VALE3.SA', 'BOVA11.SA', 'ITUB4.SA']
    lista_opcoes = []
    
    for t in tickers:
        ativo = yf.Ticker(t)
        if ativo.options:
            # Pega a grade de op√ß√µes mais pr√≥xima
            grade = ativo.option_chain(ativo.options[0])
            df = pd.concat([grade.calls, grade.puts])
            lista_opcoes.append(df[['contractSymbol', 'volume', 'lastPrice']])
    
    msg = EmailMessage()
    if lista_opcoes:
        # Encontra a op√ß√£o mais negociada do dia
        campea = pd.concat(lista_opcoes).sort_values(by='volume', ascending=False).iloc[0]
        t_nome, vol, preco = campea['contractSymbol'], int(campea['volume']), campea['lastPrice']
        
        msg['Subject'] = f"üöÄ Op√ß√£o L√≠der: {t_nome}"
        msg.set_content(f"Relat√≥rio do Rob√¥:\n\nTicker: {t_nome}\nVolume: {vol}\nPre√ßo: R$ {preco:.2f}")
    else:
        msg['Subject'] = "Mercado Fechado"
        msg.set_content("N√£o houve negocia√ß√µes hoje.")

    msg['From'] = EMAIL_USER
    msg['To'] = EMAIL_USER
    
    # Envia o e-mail usando a senha secreta
    with smtplib.SMTP_SSL('smtp.gmail.com', 465) as smtp:
        smtp.login(EMAIL_USER, SUA_SENHA_APP)
        smtp.send_message(msg)

if __name__ == "__main__":
    enviar_relatorio()
